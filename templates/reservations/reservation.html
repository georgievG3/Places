{% extends 'common/base.html' %}

{% block content %}

    <h2>Резервирай: {{ listing.title }}</h2>

    <div id="calendar" style="max-width: 800px; margin-bottom: 30px;"></div>

    <form method="post">
        {% csrf_token %}
        <p>Избрани дати:</p>
        {{ form.check_in.label }} {{ form.check_in }}
        {{ form.check_out.label }} {{ form.check_out }}

        <p>Вашите данни:</p>
        {{ form.full_name.label }} {{ form.full_name }}
        {{ form.phone.label }} {{ form.phone }}
        {{ form.note.label }} {{ form.note }}

        <button type="submit">Резервирай</button>
    </form>

    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css" rel="stylesheet">
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.18/index.global.min.js'></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const calendarEl = document.getElementById('calendar');
            const checkInInput = document.querySelector('input[name="check_in"]');
            const checkOutInput = document.querySelector('input[name="check_out"]');

            const reservedRanges = [
                {% for res in listing.reservations.all %}
                    {
                        start: "{{ res.check_in|date:'Y-m-d' }}",
                        end: "{{ res.check_out|date:'Y-m-d' }}",
                    },
                {% endfor %}
            ];

            let firstClickDate = null;

            function isDateRangeAvailable(start, end) {
                return !reservedRanges.some(r => {
                    return !(end <= r.start || start >= r.end);
                });
            }

            function isBeforeToday(dateStr) {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const date = new Date(dateStr);
                date.setHours(0, 0, 0, 0);
                return date < today;
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                selectable: false,
                events: [
                    {% for res in listing.reservations.all %}
                        {
                            title: "Заето",
                            start: "{{ res.check_in|date:'Y-m-d' }}",
                            end: "{{ res.check_out|date:'Y-m-d' }}",
                            color: "red",
                            rendering: 'background'
                        },
                    {% endfor %}
                ],
                dateClick: function (info) {
                    const clickedDate = info.dateStr;
                    const clicked = new Date(clickedDate);
                    clicked.setHours(0, 0, 0, 0);

                    if (!firstClickDate && clicked <= today) {
                        alert("Резервацията трябва да започва най-рано от утре.");
                        return;
                    }

                    if (!firstClickDate) {
                        firstClickDate = clickedDate;
                        checkInInput.value = clickedDate;
                        checkOutInput.value = '';

                        calendar.getEvents().forEach(event => {
                            if (event.extendedProps && event.extendedProps.selected) {
                                event.remove();
                            }
                        });
                    } else {
                        let start = firstClickDate;
                        let end = clickedDate;

                        if (start > end) {
                            [start, end] = [end, start];
                        }

                        const startDate = new Date(start);
                        const endDate = new Date(end);
                        startDate.setHours(0, 0, 0, 0);
                        endDate.setHours(0, 0, 0, 0);

                        const diffTime = endDate.getTime() - startDate.getTime();
                        const diffDays = diffTime / (1000 * 3600 * 24);

                        if (diffDays < 1) {
                            alert("Минималният период за резервация е 1 нощ.");
                            checkInInput.value = '';
                            checkOutInput.value = '';
                            firstClickDate = null;
                            return;
                        }

                        const realEnd = end;
                        const calendarEnd = new Date(end);
                        calendarEnd.setDate(calendarEnd.getDate() + 1);
                        const calendarEndFormatted = calendarEnd.toISOString().split('T')[0];

                        if (!isDateRangeAvailable(start, calendarEndFormatted)) {
                            alert("Избраният период съдържа заети дни.");
                            checkInInput.value = '';
                            checkOutInput.value = '';
                            firstClickDate = null;
                            return;
                        }

                        checkInInput.value = start;
                        checkOutInput.value = realEnd;

                        calendar.getEvents().forEach(event => {
                            if (event.extendedProps && event.extendedProps.selected) {
                                event.remove();
                            }
                        });

                        calendar.addEvent({
                            title: 'Избрано',
                            start: start,
                            end: calendarEndFormatted,
                            color: 'green',
                            display: 'background',
                            extendedProps: {
                                selected: true
                            }
                        });

                        firstClickDate = null;
                    }
                }
            });

            calendar.render();
        });
    </script>
{% endblock %}